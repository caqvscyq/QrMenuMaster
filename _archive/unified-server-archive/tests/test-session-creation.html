<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Creation Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-card { background: white; margin: 15px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { border-left: 4px solid #28a745; background: #d4edda; }
        .error { border-left: 4px solid #dc3545; background: #f8d7da; }
        .info { border-left: 4px solid #17a2b8; background: #d1ecf1; }
        button { padding: 12px 20px; margin: 8px 4px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; background: #007bff; color: white; }
        .log { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        h1 { color: #333; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Session Creation Test</h1>
        
        <div class="test-card info">
            <h3>Current Status</h3>
            <p><strong>URL:</strong> <span id="currentUrl"></span></p>
            <p><strong>Table Number:</strong> <span id="tableNumber"></span></p>
            <p><strong>Session ID:</strong> <span id="sessionId">Not created</span></p>
            <p><strong>Session Format:</strong> <span id="sessionFormat">Unknown</span></p>
        </div>
        
        <div class="test-card">
            <h3>Actions</h3>
            <button onclick="testSessionCreation()">Create Session</button>
            <button onclick="testCartAccess()">Test Cart Access</button>
            <button onclick="testAddToCart()">Test Add to Cart</button>
            <button onclick="clearSession()">Clear Session</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="test-card">
            <h3>Test Log</h3>
            <div id="testLog" class="log">Ready to test...\n</div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        
        function getTableNumber() {
            const params = new URLSearchParams(window.location.search);
            return params.get('table') || 'unknown';
        }
        
        function updateStatus() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('tableNumber').textContent = getTableNumber();
            document.getElementById('sessionId').textContent = currentSessionId || 'Not created';
            
            if (currentSessionId) {
                const tableNumber = getTableNumber();
                const correctPattern = new RegExp(`^session-${tableNumber}-\\d{13}-[A-Za-z0-9]{6,15}$`);
                const isCorrect = correctPattern.test(currentSessionId);
                document.getElementById('sessionFormat').textContent = isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect';
                document.getElementById('sessionFormat').style.color = isCorrect ? 'green' : 'red';
            } else {
                document.getElementById('sessionFormat').textContent = 'Unknown';
                document.getElementById('sessionFormat').style.color = 'gray';
            }
        }
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        async function testSessionCreation() {
            const tableNumber = getTableNumber();
            
            if (tableNumber === 'unknown') {
                log('‚ùå No table number in URL. Add ?table=X to URL', 'error');
                return;
            }
            
            try {
                log(`üîÑ Creating session for table ${tableNumber}...`);
                
                const response = await fetch('/api/session/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tableNumber: tableNumber,
                        shopId: 1,
                        expirationHours: 4
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.session) {
                    currentSessionId = data.session.id;
                    window.__currentSessionId = currentSessionId;
                    localStorage.setItem(`session-backup-${tableNumber}`, currentSessionId);
                    
                    log(`‚úÖ Session created: ${currentSessionId}`);
                    
                    // Verify format
                    const expectedPattern = new RegExp(`^session-${tableNumber}-\\d{13}-[A-Za-z0-9]{6,15}$`);
                    if (expectedPattern.test(currentSessionId)) {
                        log('‚úÖ Session format is correct');
                    } else {
                        log(`‚ùå Session format is incorrect: ${currentSessionId}`);
                    }
                    
                    updateStatus();
                } else {
                    throw new Error(data.message || 'Failed to create session');
                }
            } catch (error) {
                log(`‚ùå Session creation failed: ${error.message}`);
            }
        }
        
        async function testCartAccess() {
            if (!currentSessionId) {
                log('‚ùå No session ID. Create a session first.');
                return;
            }
            
            try {
                log('üõí Testing cart access...');
                
                const response = await fetch(`/api/cart/${currentSessionId}`, {
                    headers: { 
                        'X-Session-ID': currentSessionId,
                        'X-Table-Number': getTableNumber()
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Cart access successful! Items: ${data.length}`);
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Cart access failed: ${response.status} ${errorData.message}`);
                }
            } catch (error) {
                log(`‚ùå Cart access error: ${error.message}`);
            }
        }
        
        async function testAddToCart() {
            if (!currentSessionId) {
                log('‚ùå No session ID. Create a session first.');
                return;
            }
            
            try {
                log('‚ûï Testing add to cart...');
                
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Session-ID': currentSessionId,
                        'X-Table-Number': getTableNumber()
                    },
                    body: JSON.stringify({
                        menuItemId: 1,
                        quantity: 1
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Add to cart successful! Total items: ${data.length}`);
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Add to cart failed: ${response.status} ${errorData.message}`);
                }
            } catch (error) {
                log(`‚ùå Add to cart error: ${error.message}`);
            }
        }
        
        function clearSession() {
            currentSessionId = null;
            window.__currentSessionId = null;
            const tableNumber = getTableNumber();
            localStorage.removeItem(`session-backup-${tableNumber}`);
            updateStatus();
            log('üóëÔ∏è Session cleared');
        }
        
        function clearLog() {
            document.getElementById('testLog').textContent = 'Log cleared...\n';
        }
        
        // Initialize
        updateStatus();
        log('üß™ Session creation test page loaded');
        log(`üìã Table number from URL: ${getTableNumber()}`);
        
        if (getTableNumber() === 'unknown') {
            log('‚ö†Ô∏è Add ?table=X to URL to test session creation');
        }
    </script>
</body>
</html>
